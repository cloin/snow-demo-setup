- name: Retrieve catalog item details and ServiceNow request by REQ
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    req_sys_id: "{{ ansible_eda.event.payload.sys_id }}"
    default_catalog_item_name: "Unknown Item"

  tasks:
    - name: Retrieve RITM details and associated catalog item
      servicenow.itsm.api_info:
        resource: sc_req_item
        sysparm_query: request={{ req_sys_id }}
        columns: [sys_id, number, description, short_description, cat_item.name, cat_item.sys_id]
      register: ritms
      failed_when: ritms.record is not defined or ritms.record | length == 0

    - name: Retrieve all variable mappings and details
      servicenow.itsm.api_info:
        resource: sc_item_option_mtom
        sysparm_query: request_itemIN{{ ritms.record | map(attribute='sys_id') | join(',') }}
        columns: [sc_item_option.sys_id, sc_item_option.value, sc_item_option.item_option_new.value, sc_item_option.item_option_new.name]
      register: variable_mappings
      when: ritms.record | length > 0

    - name: Set facts for RITM and catalog item details
      ansible.builtin.set_fact:
        ritm_details: "{{ ritms.record }}"
        catalog_item_name: "{{ ritms.record[0].cat_item.name | default(default_catalog_item_name) }}"
        variables: >
          {{
            variable_mappings.record | map(attribute='sc_item_option') | list | map('combine', [{
              'name': item.item_option_new.name,
              'value': item.value
            }]) | list
          }}
        cacheable: true
      when: variable_mappings.record | length > 0

    - name: Debug consolidated data
      ansible.builtin.debug:
        msg:
          - "req_sys_id: {{ req_sys_id }}"
          - "ritm_details: {{ ritm_details | default('Not Defined') }}"
          - "catalog_item_name: {{ catalog_item_name | default('Unknown Item') }}"
          - "variables: {{ variables | default([]) }}"

    - name: Consolidate all facts and original event into set_stats
      ansible.builtin.set_stats:
        data:
          enriched_event: >
            {{
              {
                'req_sys_id': req_sys_id | default('Unknown Request ID'),
                'ritm_details': ritm_details | default([]),
                'catalog_item_name': catalog_item_name | default('Unknown Item'),
                'variables': variables | default([])
              }
            }}
          original_event: "{{ ansible_eda.event | default({}) }}"
